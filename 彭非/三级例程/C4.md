# C4_SSPEquilCalcs

> code

注：有非常多的局部变量，使用参数列表传递，生命周期未知。
若能确定生命周期，可以将部分变量加入到全局中或成为局部变量。

```cpp
/**
 * @brief 计算 SSP 平衡，包括沉淀和气体分配。
 *
 * 此函数执行化学平衡计算，处理沉淀、气体溶解和物种分布。
 * 它使用半区间搜索结合牛顿-拉夫逊法求解 pH 值，并处理各种气体和金属。
 */
void C4_SSPEquilCalcs(int ppt_or_not, int im, int igas, double Ksp,
    int useEOS, double RatioOilBPoints, double KH2O, double aH2O, double KgoCH4, double KgwCH4, double KgoCO2, double KgwCO2,
    double K1H2CO3, double K2HCO3, double KgoH2S, double KgwH2S, double K1H2S, double K2HS,
    double Ppsia, bool* mf_ParametersWereRead, double* mf_TCr, double* mf_PCr, double* mf_Omega, double* mf_MWgas,
    double** mf_kPr, double* mf_c0, double* mf_c1, double TK, double PBar, int RunH2SGUI,
    int myiosheet, int myiocol, double* mass_phase, double* MW_Phase,
    int* No_Phases, double KspCaOH2, double KspMgOH2, double KspGreenalite, double KspDiopside, double KspChrysotile, 
    double KspAmSilica, double KspQuartz, double KH4SiO4, double KH3SiO3, double KHAc,
    double KH3BO3, double KNH4, double KstFeSaq, int* errmsg,double* pH, double* ppt, double* PCO2, double* PH2S, double* PCH4,
    double* CO3, double* HS, double* S, double* AC, double* NH3, double* H2SiO4, double* H3SiO4,
    double* H4SiO4, double* pptAmSilica, double* Vg_ZRT, double* CO2aq, double* H2Saq, double* HCO3, double* HAcaq, double* H2BO3,
    double TZn, double TPb, double ZP1, double ZP2, double ZP3, double ZP4, double ZP5, double ZP6, double ZP7)
{
    int RunPpt = (ppt_or_not == 1) ? 1 : 0;

    *ppt = 0.0;

    double pHHigh = 14.0;
    double pHLow = 0.0;
    double aH, H, OH;
    double pptOld, Vg_ZRT_Old;
    int Iteration;
    double t1, t2, t3, s1, s2, s3;
    double coef1, coef2, coef3, coef4;
    double root1, root2, root3;
    double total_moles_Temp;
    double zTemp[15];
    double a, b, cc;
    double kc, pptNew, fppt, dfppt;
    int ISilicate;
    double TH4SiO4_Greenalite, TH4SiO4_Diopside, TH4SiO4_Chrysotile;
    double hydHS, mt, hydAc, hydH2BO3, hydNH3, hydH2SiO4;
    double faH;
    double xpH[30], ypH[30], xppt[30];
    double gNeutAq[2] = { gNeut[iCO2aq], gNeut[iH2Saq] }; // Array for MultiPhaseFlash

    for (int i = 0; i < 30; i++) {
        *pH = (pHHigh + pHLow) / 2.0;
        aH = pow(10.0, -(*pH));
        H = aH / (gCat[iH] * gNCat[iH]);
        OH = KH2O / (aH * gAn[iOH] * gNAn[iOH]);

        *ppt = 0.0;
        pptOld = 1e42;
        *Vg_ZRT = 0.0;
        Vg_ZRT_Old = 1e42;
        Iteration = 0;

        while (fabs((*ppt - pptOld + 1e-21) / (*ppt + pptOld + 1e-16)) +
            fabs((*Vg_ZRT - Vg_ZRT_Old + 1e-21) / (*Vg_ZRT + Vg_ZRT_Old + 1e-16)) > 0.0001 && Iteration < 100) {
            Iteration++;
            pptOld = *ppt;
            Vg_ZRT_Old = *Vg_ZRT;

            if (useEOS == 0) {
                t1 = gGas[iCH4g] * (RatioOilBPoints * KgoCH4 * Mass_o / gL[iCH4o] +
                    KgwCH4 * mass_w / (gNeut[iCH4aq] * gNNeut[iCH4aq]));
                t2 = gGas[iCO2g] * (RatioOilBPoints * KgoCO2 * Mass_o / gL[iCO2o] +
                    KgwCO2 * mass_w * (1.0 / (gNeut[iCO2aq] * gNNeut[iCO2aq]) +
                        (K1H2CO3 * aH2O) / (aH * gAn[iHCO3] * gNAn[iHCO3]) +
                        (K1H2CO3 * aH2O) * K2HCO3 / (aH * aH * gAn[iCO3] * gNAn[iCO3])));
                t3 = gGas[iH2Sg] * (RatioOilBPoints * KgoH2S * Mass_o / gL[iH2So] +
                    KgwH2S * mass_w * (1.0 / (gNeut[iH2Saq] * gNNeut[iH2Saq]) +
                        K1H2S / (aH * gAn[iHS] * gNAn[iHS]) +
                        K1H2S * K2HS / (aH * aH * gAn[iSion] * gNAn[iSion])));
                s1 = nTCH4 / Ppsia;
                s2 = nTCO2 / Ppsia;
                if (igas == 2) s2 = (nTCO2 - *ppt * mass_w) / Ppsia;
                s3 = nTH2S / Ppsia;
                if (igas == 3) s3 = (nTH2S - *ppt * mass_w) / Ppsia;
                coef1 = 1.0;
                coef2 = t1 + t2 + t3 - (s1 + s2 + s3);
                coef3 = t1 * t2 + t1 * t3 + t2 * t3 - (s1 * t2 + s1 * t3 + s3 * t1 + s3 * t2 + s2 * t1 + s2 * t3);
                coef4 = t1 * t2 * t3 - (t1 * t2 * s3 + t1 * t3 * s2 + t2 * t3 * s1);
                CubicRoots(coef1, coef2, coef3, coef4, &root1, &root2, &root3);
                *Vg_ZRT = root1;
                if (root2 > *Vg_ZRT) *Vg_ZRT = root2;
                if (root3 > *Vg_ZRT) *Vg_ZRT = root3;
                if (*Vg_ZRT < 0.0) *Vg_ZRT = 0.0;
            }

            if (ppt_or_not == 0) goto label223;

            if (igas == 2) {
                if (useEOS == 0) {
                    a = 1.0;
                    b = -(mc[im] * mass_w + nTCO2) / mass_w;
                    cc = (mc[im] * nTCO2 - Ksp * (*Vg_ZRT + t2) * (aH * aH) / ((K1H2CO3 * aH2O) * K2HCO3 * KgwCO2 * gGas[iCO2g] * gCat[im] * gNCat[im])) / mass_w;
                }
                else {
                    total_moles_Temp = Total_moles_before_precipitation - *ppt;
                    zTemp[0] = z_before_precipitation[0] * Total_moles_before_precipitation / total_moles_Temp;
                    zTemp[1] = (z_before_precipitation[1] * Total_moles_before_precipitation - *ppt * mass_w) / total_moles_Temp;
                    if (zTemp[1] < 0.0) {
                        *ppt = 0.0;
                        goto label223;
                    }
                    for (int iz = 2; iz < 15; iz++) {
                        zTemp[iz] = z_before_precipitation[iz] * Total_moles_before_precipitation / total_moles_Temp;
                    }
                    if (RunH2SGUI != 1) {
                        MultiPhaseFlash(mf_ParametersWereRead, mf_TCr, mf_PCr, mf_Omega, mf_MWgas, mf_kPr, mf_c0, mf_c1, TK, 
                            PBar, total_moles_Temp, zTemp, gNeutAq, aH2O, density, compositions, phi, Compr, beta, zOutput, &mass_phase, &MW_Phase, No_Phases);
                    }
                    else {
                        MultiPhaseFlash_CS(&myiosheet, myiocol, eosProps, kij, TK, PBar, total_moles_Temp, zTemp, gNeutAq,
                            aH2O, density, compositions, phi, Compr, beta, zOutput, mass_phase, MW_Phase, No_Phases);
                    }
                    *PCO2 = compositions[1][3] * phi[1][2] * Ppsia / gGas[iCO2g];
                    a = 1.0;
                    b = -(mc[im] * mass_w + nTCO2) / mass_w;
                    cc = (mc[im] * nTCO2 - Ksp * (nTCO2 / *PCO2) * (aH * aH) / ((K1H2CO3 * aH2O) * K2HCO3 * KgwCO2 * gGas[iCO2g] * gCat[im] * gNCat[im])) / mass_w;
                }
                QuadraticRoots(a, b, cc, ppt, &root2);
            }

            if (igas == 3) {
                if (useEOS == 0) {
                    a = 1.0;
                    b = -(mc[im] * mass_w + nTH2S) / mass_w;
                    cc = (mc[im] * nTH2S - Ksp * (*Vg_ZRT + t3) * (aH * aH) / (K1H2S * KgwH2S * gGas[iH2Sg] * gCat[im] * gNCat[im])) / mass_w;
                }
                else {
                    total_moles_Temp = Total_moles_before_precipitation - *ppt;
                    for (int iz = 0; iz < 2; iz++) {
                        zTemp[iz] = z_before_precipitation[iz] * Total_moles_before_precipitation / total_moles_Temp;
                    }
                    zTemp[2] = (z_before_precipitation[2] * Total_moles_before_precipitation - *ppt * mass_w) / total_moles_Temp;
                    if (zTemp[2] < 0.0) {
                        *ppt = 0.0;
                        goto label223;
                    }
                    for (int iz = 3; iz < 15; iz++) {
                        zTemp[iz] = z_before_precipitation[iz] * Total_moles_before_precipitation / total_moles_Temp;
                    }
                    if (RunH2SGUI != 1) {
                        MultiPhaseFlash(mf_ParametersWereRead, mf_TCr, mf_PCr, mf_Omega, mf_MWgas, mf_kPr, mf_c0, mf_c1, TK, 
                            PBar, total_moles_Temp, zTemp, gNeutAq, aH2O, density, compositions, phi, Compr, beta, zOutput, &mass_phase, &MW_Phase, No_Phases);
                    }
                    else {
                        MultiPhaseFlash_CS(&myiosheet, myiocol, eosProps, kij, TK, PBar, total_moles_Temp, zTemp, gNeutAq, 
                            aH2O, density, compositions, phi, Compr, beta, zOutput, mass_phase, MW_Phase, No_Phases);
                    }
                    *PH2S = compositions[2][3] * phi[2][2] * Ppsia / gGas[iH2Sg];
                    a = 1.0;
                    b = -(mc[im] * mass_w + nTH2S) / mass_w;
                    cc = (mc[im] * nTH2S - Ksp * (nTH2S / *PH2S) * (aH * aH) / (K1H2S * KgwH2S * gGas[iH2Sg] * gCat[im] * gNCat[im])) / mass_w;
                }
                QuadraticRoots(a, b, cc, ppt, &root2);
            }

            if (igas == 8) {
                *ppt = mc[iCa] - KspCaOH2 / (OH * OH * gCat[iCa] * gAn[iOH] * gAn[iOH]);
            }
            if (igas == 9) {
                *ppt = mc[iMg] - KspMgOH2 / (OH * OH * gCat[iMg] * gAn[iOH] * gAn[iOH]);
            }

            if (igas == 12) {
                kc = KspGreenalite * pow(aH, 6) / (pow(gCat[iFe], 3) * pow(gNeut[iH4SiO4aq], 2));
                if (mc[iFe] / 3.0 >= TH4SiO4 / 2.0) pptNew = (TH4SiO4 - pow(kc / pow(mc[iFe], 3), 0.5)) / 2.0;
                else pptNew = (mc[iFe] - pow(kc / pow(TH4SiO4, 2), 0.3333)) / 3.0;
                ISilicate = 0;
                while (ISilicate < 1000 && fabs((pptNew - *ppt) / pptNew) > 0.00001) {
                    ISilicate++;
                    *ppt = pptNew;
                    fppt = pow(mc[iFe] - 3.0 * *ppt, 3) * pow(TH4SiO4 - 2.0 * *ppt, 2) - kc;
                    dfppt = -1.0 * (9.0 * pow(mc[iFe] - 3.0 * *ppt, 2) * pow(TH4SiO4 - 2.0 * *ppt, 2) + 4.0 * pow(mc[iFe] - 3.0 * *ppt, 3) * (TH4SiO4 - 2.0 * *ppt));
                    if ((mc[iFe] - 3.0 * *ppt) == 0.0 || (TH4SiO4 - 2.0 * *ppt) == 0.0) goto label312;
                    pptNew = *ppt - fppt / dfppt;
                    if (ISilicate == 999) errmsg[5] = 6;
                }
            label312:
                TH4SiO4_Greenalite = TH4SiO4 - 2.0 * *ppt;
                *ppt = *ppt * 6.0 / 2.0;
            }

            if (igas == 13) {
                kc = KspDiopside * pow(aH, 4) / (gCat[iCa] * gCat[iMg] * pow(gNeut[iH4SiO4aq], 2));
                if (mc[iCa] < mc[iMg] && mc[iCa] < TH4SiO4 / 2.0) pptNew = mc[iCa] - kc / (mc[iMg] * pow(TH4SiO4, 2));
                else if (mc[iMg] < mc[iCa] && mc[iMg] < TH4SiO4 / 2.0) pptNew = mc[iMg] - kc / (mc[iCa] * pow(TH4SiO4, 2));
                else pptNew = (TH4SiO4 - pow(kc / (mc[iCa] * mc[iMg]), 0.5)) / 2.0;
                ISilicate = 0;
                while (ISilicate < 1000 && fabs((pptNew - *ppt) / pptNew) > 0.00001) {
                    ISilicate++;
                    *ppt = pptNew;
                    fppt = (mc[iCa] - *ppt) * (mc[iMg] - *ppt) * pow(TH4SiO4 - 2.0 * *ppt, 2) - kc;
                    dfppt = -1.0 * ((mc[iMg] - *ppt) * pow(TH4SiO4 - 2.0 * *ppt, 2) + (mc[iCa] - *ppt) * pow(TH4SiO4 - 2.0 * *ppt, 2) + 4.0 * (mc[iCa] - *ppt) * (mc[iMg] - *ppt) * (TH4SiO4 - 2.0 * *ppt));
                    if ((mc[iMg] - *ppt) == 0.0 || (TH4SiO4 - 2.0 * *ppt) == 0.0 || (mc[iCa] - *ppt) == 0.0) goto label313;
                    pptNew = *ppt - fppt / dfppt;
                    if (ISilicate == 999) errmsg[5] = 6;
                }
            label313:
                *ppt = *ppt * 4.0 / 2.0;
                TH4SiO4_Diopside = TH4SiO4 - 2.0 * *ppt;
            }

            if (igas == 14) {
                kc = KspChrysotile * pow(aH, 6) / (pow(gCat[iMg], 3) * pow(gNeut[iH4SiO4aq], 2));
                if (mc[iMg] / 3.0 >= TH4SiO4 / 2.0) pptNew = (TH4SiO4 - pow(kc / pow(mc[iMg], 3), 0.5)) / 2.0;
                else pptNew = (mc[iMg] - pow(kc / pow(TH4SiO4, 2), 0.3333)) / 3.0;
                ISilicate = 0;
                while (ISilicate < 1000 && fabs((pptNew - *ppt) / pptNew) > 0.00001) {
                    ISilicate++;
                    *ppt = pptNew;
                    fppt = pow(mc[iMg] - 3.0 * *ppt, 3) * pow(TH4SiO4 - 2.0 * *ppt, 2) - kc;
                    if ((mc[iMg] - 3.0 * *ppt) == 0.0 || (TH4SiO4 - 2.0 * *ppt) == 0.0) goto label314;
                    dfppt = -1.0 * (9.0 * pow(mc[iMg] - 3.0 * *ppt, 2) * pow(TH4SiO4 - 2.0 * *ppt, 2) + 4.0 * pow(mc[iMg] - 3.0 * *ppt, 3) * (TH4SiO4 - 2.0 * *ppt));
                    pptNew = *ppt - fppt / dfppt;
                    if (ISilicate == 999) errmsg[5] = 6;
                }
            label314:
                *ppt = *ppt * 6.0 / 2.0;
                TH4SiO4_Chrysotile = TH4SiO4 - 2.0 * *ppt;
            }

            if (ppt_or_not == 1 && *ppt < 0.0) *ppt = 0.0;
            if (Iteration == 1 && igas > 3) goto label223;
        }
    label223:
        if (useEOS == 0) {
            *PCH4 = nTCH4 / (*Vg_ZRT + t1);
            *PCO2 = nTCO2 / (*Vg_ZRT + t2);
            if (igas == 2) *PCO2 = (nTCO2 - *ppt * mass_w) / (*Vg_ZRT + t2);
            *PH2S = nTH2S / (*Vg_ZRT + t3);
            if (igas == 3) *PH2S = (nTH2S - *ppt * mass_w) / (*Vg_ZRT + t3);
        }
        else {
            *PCO2 = compositions[1][3] * phi[1][2] * Ppsia / gGas[iCO2g];
            *PH2S = compositions[2][3] * phi[2][2] * Ppsia / gGas[iH2Sg];
        }
        *CO2aq = KgwCO2 * *PCO2 * gGas[iCO2g] / (gNeut[iCO2aq] * gNNeut[iCO2aq]);
        *H2Saq = KgwH2S * *PH2S * gGas[iH2Sg] / (gNeut[iH2Saq] * gNNeut[iH2Saq]);
        *HCO3 = (K1H2CO3 * aH2O) * *CO2aq * gNeut[iCO2aq] * gNNeut[iCO2aq] / (aH * gAn[iHCO3] * gNAn[iHCO3]);
        *CO3 = K2HCO3 * *HCO3 * gAn[iHCO3] * gNAn[iHCO3] / (aH * gAn[iCO3] * gNAn[iCO3]);
        *HS = K1H2S * *H2Saq * gNeut[iH2Saq] * gNNeut[iH2Saq] / (aH * gAn[iHS] * gNAn[iHS]);
        TH2Saq = *H2Saq + *HS;
        hydHS = aH * gAn[iHS] * gNAn[iHS] / (K1H2S * gNeut[iH2Saq] * gNNeut[iH2Saq]) + 1.0;
        if (nTH2S > 0.0) {
            //double fMeSSpeciation(int im, int igas, double* HS, double TFe, double TZn, double TPb,
            //    double TH2Saq, double hydHS, double ppt, double ZP1, double ZP2, double ZP3, double ZP4,
            //    double ZP5, double ZP6, double ZP7, double* mc, int iFe, int iZn, int iPb, double* root1, double* root2, double* root3)
            mt = fMeSSpeciation(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, *ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, &root1, &root2, &root3);
        }
        *S = K2HS * *HS * gAn[iHS] * gNAn[iHS] / (aH * gAn[iSion] * gNAn[iSion]);
        hydAc = aH * gAn[iAc] * gNAn[iAc] / (KHAc * gNeut[iHAcaq] * gNNeut[iHAcaq]) + 1.0;
        *AC = TAc / hydAc;
        *HAcaq = TAc - *AC;
        hydH2BO3 = aH * gAn[iH2BO3] * gNAn[iH2BO3] / (KH3BO3 * gNeut[iH3BO3] * gNNeut[iH3BO3]) + 1.0;
        *H2BO3 = TH3BO3 / hydH2BO3;
        hydNH3 = aH * gNeut[iNH3] * gNNeut[iNH3] / (KNH4 * gCat[iNH4] * gNCat[iNH4]) + 1.0;
        *NH3 = TNH4 / hydNH3;

        hydH2SiO4 = (aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq])) +
            (aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4])) + 1.0;
        *H2SiO4 = TH4SiO4 / hydH2SiO4;
        *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
        *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);

        if (igas == 10) {
            *H4SiO4 = KspAmSilica / gNeut[iH4SiO4aq];
            *H3SiO4 = KH4SiO4 * KspAmSilica / (aH * gAn[iH3SiO4]);
            *H2SiO4 = KH4SiO4 * KH3SiO3 * KspAmSilica / (aH * aH * gAn[iH2SiO4]);
            *pptAmSilica = TH4SiO4 - (*H2SiO4 + *H3SiO4 + *H4SiO4);
        }
        if (igas == 11) {
            *H4SiO4 = KspQuartz;
            *H3SiO4 = KH4SiO4 * KspQuartz / aH;
            *H2SiO4 = KH4SiO4 * KH3SiO3 * KspQuartz / (aH * aH); // Note: VB has KspAmSilica, probably typo, changed to KspQuartz
        }

        if (igas == 12) {
            *H2SiO4 = TH4SiO4_Greenalite / hydH2SiO4;
            *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
            *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);
        }
        if (igas == 13) {
            *H2SiO4 = TH4SiO4_Diopside / hydH2SiO4;
            *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
            *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);
        }
        if (igas == 14) {
            *H2SiO4 = TH4SiO4_Chrysotile / hydH2SiO4;
            *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
            *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);
        }

        faH = Alk - 2.0 * *ppt - (*HCO3 + 2.0 * *CO3 + *HS + 2.0 * *S + *AC + *NH3 + *H2BO3 + *H3SiO4 + 2.0 * *H2SiO4 + OH - H);
        ypH[i] = faH;
        xpH[i] = *pH;
        xppt[i] = *ppt;
        if (faH > 0.0) pHLow = *pH;
        if (faH < 0.0) pHHigh = *pH;
    }

    // Newton-Raphson
    if (fabs(ypH[29] / ((ypH[29] - ypH[28]) / (xpH[29] - xpH[28]))) < 0.001) {
        *pH = *pH - ypH[29] / ((ypH[29] - ypH[28]) / (xpH[29] - xpH[28]));
    }
    else {
        *pH = fabs((xpH[29] + xpH[28])) / 2.0;
        if (RunPpt == 0) errmsg[4] = 5; // VB errmsg(5)=5, 0-based [4]
    }

    aH = pow(10.0, -(*pH));
    H = aH / (gCat[iH] * gNCat[iH]);
    OH = KH2O / (aH * gAn[iOH] * gNAn[iOH]);

    *ppt = 0.0;
    pptOld = 1e42;
    *Vg_ZRT = 0.0;
    Vg_ZRT_Old = 1e42;
    Iteration = 0;

    while (fabs((*ppt - pptOld + 1e-21) / (*ppt + pptOld + 1e-16)) +
        fabs((*Vg_ZRT - Vg_ZRT_Old + 1e-21) / (*Vg_ZRT + Vg_ZRT_Old + 1e-16)) > 0.0001 && Iteration < 100) {
        Iteration++;
        pptOld = *ppt;
        Vg_ZRT_Old = *Vg_ZRT;

        if (useEOS == 0) {
            t1 = gGas[iCH4g] * (RatioOilBPoints * KgoCH4 * Mass_o / gL[iCH4o] +
                KgwCH4 * mass_w / (gNeut[iCH4aq] * gNNeut[iCH4aq]));
            t2 = gGas[iCO2g] * (RatioOilBPoints * KgoCO2 * Mass_o / gL[iCO2o] +
                KgwCO2 * mass_w * (1.0 / (gNeut[iCO2aq] * gNNeut[iCO2aq]) +
                    (K1H2CO3 * aH2O) / (aH * gAn[iHCO3] * gNAn[iHCO3]) +
                    (K1H2CO3 * aH2O) * K2HCO3 / (aH * aH * gAn[iCO3] * gNAn[iCO3])));
            t3 = gGas[iH2Sg] * (RatioOilBPoints * KgoH2S * Mass_o / gL[iH2So] +
                KgwH2S * mass_w * (1.0 / (gNeut[iH2Saq] * gNNeut[iH2Saq]) +
                    K1H2S / (aH * gAn[iHS] * gNAn[iHS]) +
                    K1H2S * K2HS / (aH * aH * gAn[iSion] * gNAn[iSion])));
            s1 = nTCH4 / Ppsia;
            s2 = nTCO2 / Ppsia;
            if (igas == 2) s2 = (nTCO2 - *ppt * mass_w) / Ppsia;
            s3 = nTH2S / Ppsia;
            if (igas == 3) s3 = (nTH2S - *ppt * mass_w) / Ppsia;
            coef1 = 1.0;
            coef2 = t1 + t2 + t3 - (s1 + s2 + s3);
            coef3 = t1 * t2 + t1 * t3 + t2 * t3 - (s1 * t2 + s1 * t3 + s3 * t1 + s3 * t2 + s2 * t1 + s2 * t3);
            coef4 = t1 * t2 * t3 - (t1 * t2 * s3 + t1 * t3 * s2 + t2 * t3 * s1);
            CubicRoots(coef1, coef2, coef3, coef4, &root1, &root2, &root3);
            *Vg_ZRT = root1;
            if (root2 > *Vg_ZRT) *Vg_ZRT = root2;
            if (root3 > *Vg_ZRT) *Vg_ZRT = root3;
            if (*Vg_ZRT < 0.0) *Vg_ZRT = 0.0;
        }

        if (ppt_or_not == 0) goto label323;

        if (igas == 2) {
            if (useEOS == 0) {
                a = 1.0;
                b = -(mc[im] * mass_w + nTCO2) / mass_w;
                cc = (mc[im] * nTCO2 - Ksp * (*Vg_ZRT + t2) * (aH * aH) / ((K1H2CO3 * aH2O) * K2HCO3 * KgwCO2 * gGas[iCO2g] * gCat[im] * gNCat[im])) / mass_w;
            }
            else {
                total_moles_Temp = Total_moles_before_precipitation - *ppt;
                zTemp[0] = z_before_precipitation[0] * Total_moles_before_precipitation / total_moles_Temp;
                zTemp[1] = (z_before_precipitation[1] * Total_moles_before_precipitation - *ppt * mass_w) / total_moles_Temp;
                for (int iz = 2; iz < 15; iz++) {
                    zTemp[iz] = z_before_precipitation[iz] * Total_moles_before_precipitation / total_moles_Temp;
                }
                if (RunH2SGUI != 1) {
                    MultiPhaseFlash(mf_ParametersWereRead, mf_TCr, mf_PCr, mf_Omega, mf_MWgas, mf_kPr, mf_c0, mf_c1, TK, 
                        PBar, total_moles_Temp, zTemp, gNeutAq, aH2O, density, compositions, phi, Compr, beta, zOutput, &mass_phase, &MW_Phase, No_Phases);
                }
                else {
                    MultiPhaseFlash_CS(&myiosheet, myiocol, eosProps, kij, TK, PBar, total_moles_Temp, zTemp, gNeutAq, 
                        aH2O, density, compositions, phi, Compr, beta, zOutput, mass_phase, MW_Phase, No_Phases);
                }
                *CO2aq = compositions[1][3] * beta[2] * total_moles_Temp / mass_w / (gNeut[iCO2aq] * gNNeut[iCO2aq]); // Assume beta[2] water?
                a = 1.0;
                b = -(mc[im] + *CO2aq * gNeut[iCO2aq] * gNNeut[iCO2aq] * (K1H2CO3 * aH2O) / (aH * gAn[iHCO3] * gNAn[iHCO3]));
                cc = (mc[im] * *CO2aq * gNeut[iCO2aq] * gNNeut[iCO2aq] * (K1H2CO3 * aH2O) / (aH * gAn[iHCO3] * gNAn[iHCO3]) - Ksp * aH / K2HCO3);
            }
            QuadraticRoots(a, b, cc, ppt, &root2);
        }

        if (igas == 3) {
            if (useEOS == 0) {
                a = 1.0;
                b = -(mc[im] * mass_w + nTH2S) / mass_w;
                cc = (mc[im] * nTH2S - Ksp * (*Vg_ZRT + t3) * (aH * aH) / (K1H2S * KgwH2S * gGas[iH2Sg] * gCat[im] * gNCat[im])) / mass_w;
            }
            else {
                total_moles_Temp = Total_moles_before_precipitation - *ppt;
                for (int iz = 0; iz < 2; iz++) {
                    zTemp[iz] = z_before_precipitation[iz] * Total_moles_before_precipitation / total_moles_Temp;
                }
                zTemp[2] = (z_before_precipitation[2] * Total_moles_before_precipitation - *ppt * mass_w) / total_moles_Temp;
                for (int iz = 3; iz < 15; iz++) {
                    zTemp[iz] = z_before_precipitation[iz] * Total_moles_before_precipitation / total_moles_Temp;
                }
                if (RunH2SGUI != 1) {
                    MultiPhaseFlash(mf_ParametersWereRead, mf_TCr, mf_PCr, mf_Omega, mf_MWgas, mf_kPr, mf_c0, mf_c1, TK, 
                        PBar, total_moles_Temp, zTemp, gNeutAq, aH2O, density, compositions, phi, Compr, beta, zOutput, &mass_phase, &MW_Phase, No_Phases);
                }
                else {
                    MultiPhaseFlash_CS(&myiosheet, myiocol, eosProps, kij, TK, PBar, total_moles_Temp, zTemp, gNeutAq, 
                        aH2O, density, compositions, phi, Compr, beta, zOutput, mass_phase, MW_Phase, No_Phases);
                }
                *H2Saq = compositions[2][3] * beta[2] * total_moles_Temp / mass_w / gNeut[iH2Saq] / gNNeut[iH2Saq];
                a = 1.0;
                b = -(mc[im] + *H2Saq * gNeut[iH2Saq] * gNNeut[iH2Saq] * K1H2S / (aH * gAn[iHS] * gNAn[iHS]));
                cc = (mc[im] * *H2Saq * gNeut[iH2Saq] * gNNeut[iH2Saq] * K1H2S / (aH * gAn[iHS] * gNAn[iHS]) - Ksp * aH);
            }
            QuadraticRoots(a, b, cc, ppt, &root2);
        }

        if (igas == 8) {
            *ppt = mc[iCa] - KspCaOH2 / (OH * OH * gCat[iCa] * gAn[iOH] * gAn[iOH]);
        }
        if (igas == 9) {
            *ppt = mc[iMg] - KspMgOH2 / (OH * OH * gCat[iMg] * gAn[iOH] * gAn[iOH]);
        }

        if (igas == 12) {
            kc = KspGreenalite * pow(aH, 6) / (pow(gCat[iFe], 3) * pow(gNeut[iH4SiO4aq], 2));
            if (mc[iFe] / 3.0 >= TH4SiO4 / 2.0) pptNew = (TH4SiO4 - pow(kc / pow(mc[iFe], 3), 0.5)) / 2.0;
            else pptNew = (mc[iFe] - pow(kc / pow(TH4SiO4, 2), 0.3333)) / 3.0;
            ISilicate = 0;
            while (ISilicate < 1000 && fabs((pptNew - *ppt) / pptNew) > 0.00001) {
                ISilicate++;
                *ppt = pptNew;
                fppt = pow(mc[iFe] - 3.0 * *ppt, 3) * pow(TH4SiO4 - 2.0 * *ppt, 2) - kc;
                dfppt = -1.0 * (9.0 * pow(mc[iFe] - 3.0 * *ppt, 2) * pow(TH4SiO4 - 2.0 * *ppt, 2) + 4.0 * pow(mc[iFe] - 3.0 * *ppt, 3) * (TH4SiO4 - 2.0 * *ppt));
                if ((mc[iFe] - 3.0 * *ppt) == 0.0 || (TH4SiO4 - 2.0 * *ppt) == 0.0) goto label412;
                pptNew = *ppt - fppt / dfppt;
                if (ISilicate == 999) errmsg[5] = 6;
            }
        label412:
            TH4SiO4_Greenalite = TH4SiO4 - 2.0 * *ppt;
            *ppt = *ppt * 6.0 / 2.0;
        }

        if (igas == 13) {
            kc = KspDiopside * pow(aH, 4) / (gCat[iCa] * gCat[iMg] * pow(gNeut[iH4SiO4aq], 2));
            if (mc[iCa] < mc[iMg] && mc[iCa] < TH4SiO4 / 2.0) pptNew = mc[iCa] - kc / (mc[iMg] * pow(TH4SiO4, 2));
            else if (mc[iMg] < mc[iCa] && mc[iMg] < TH4SiO4 / 2.0) pptNew = mc[iMg] - kc / (mc[iCa] * pow(TH4SiO4, 2));
            else pptNew = (TH4SiO4 - pow(kc / (mc[iCa] * mc[iMg]), 0.5)) / 2.0;
            ISilicate = 0;
            while (ISilicate < 1000 && fabs((pptNew - *ppt) / pptNew) > 0.00001) {
                ISilicate++;
                *ppt = pptNew;
                fppt = (mc[iCa] - *ppt) * (mc[iMg] - *ppt) * pow(TH4SiO4 - 2.0 * *ppt, 2) - kc;
                dfppt = -1.0 * ((mc[iMg] - *ppt) * pow(TH4SiO4 - 2.0 * *ppt, 2) + (mc[iCa] - *ppt) * pow(TH4SiO4 - 2.0 * *ppt, 2) + 4.0 * (mc[iCa] - *ppt) * (mc[iMg] - *ppt) * (TH4SiO4 - 2.0 * *ppt));
                if ((mc[iMg] - *ppt) == 0.0 || (TH4SiO4 - 2.0 * *ppt) == 0.0 || (mc[iCa] - *ppt) == 0.0) goto label413;
                pptNew = *ppt - fppt / dfppt;
                if (ISilicate == 999) errmsg[5] = 6;
            }
        label413:
            *ppt = *ppt * 4.0 / 2.0;
            TH4SiO4_Diopside = TH4SiO4 - 2.0 * *ppt;
        }

        if (igas == 14) {
            kc = KspChrysotile * pow(aH, 6) / (pow(gCat[iMg], 3) * pow(gNeut[iH4SiO4aq], 2));
            if (mc[iMg] / 3.0 >= TH4SiO4 / 2.0) pptNew = (TH4SiO4 - pow(kc / pow(mc[iMg], 3), 0.5)) / 2.0;
            else pptNew = (mc[iMg] - pow(kc / pow(TH4SiO4, 2), 0.3333)) / 3.0;
            ISilicate = 0;
            while (ISilicate < 1000 && fabs((pptNew - *ppt) / pptNew) > 0.00001) {
                ISilicate++;
                *ppt = pptNew;
                fppt = pow(mc[iMg] - 3.0 * *ppt, 3) * pow(TH4SiO4 - 2.0 * *ppt, 2) - kc;
                if ((mc[iMg] - 3.0 * *ppt) == 0.0 || (TH4SiO4 - 2.0 * *ppt) == 0.0) goto label414;
                dfppt = -1.0 * (9.0 * pow(mc[iMg] - 3.0 * *ppt, 2) * pow(TH4SiO4 - 2.0 * *ppt, 2) + 4.0 * pow(mc[iMg] - 3.0 * *ppt, 3) * (TH4SiO4 - 2.0 * *ppt));
                pptNew = *ppt - fppt / dfppt;
                if (ISilicate == 999) errmsg[5] = 6;
            }
        label414:
            *ppt = *ppt * 6.0 / 2.0;
            TH4SiO4_Chrysotile = TH4SiO4 - 2.0 * *ppt;
        }

        if (ppt_or_not == 1 && *ppt < 0.0) *ppt = 0.0;
        if (Iteration == 1 && igas > 3) goto label323;
    }
label323:
    if (useEOS == 0) {
        *PCH4 = nTCH4 / (*Vg_ZRT + t1);
        *PCO2 = nTCO2 / (*Vg_ZRT + t2);
        if (igas == 2) *PCO2 = (nTCO2 - *ppt * mass_w) / (*Vg_ZRT + t2);
        *PH2S = nTH2S / (*Vg_ZRT + t3);
        if (igas == 3) *PH2S = (nTH2S - *ppt * mass_w) / (*Vg_ZRT + t3);
    }
    else {
        *PCO2 = compositions[1][3] * phi[1][2] * Ppsia / gGas[iCO2g];
        *PH2S = compositions[2][3] * phi[2][2] * Ppsia / gGas[iH2Sg];
    }
    *CO2aq = KgwCO2 * *PCO2 * gGas[iCO2g] / (gNeut[iCO2aq] * gNNeut[iCO2aq]);
    *H2Saq = KgwH2S * *PH2S * gGas[iH2Sg] / (gNeut[iH2Saq] * gNNeut[iH2Saq]);
    *HCO3 = (K1H2CO3 * aH2O) * *CO2aq * gNeut[iCO2aq] * gNNeut[iCO2aq] / (aH * gAn[iHCO3] * gNAn[iHCO3]);
    *CO3 = K2HCO3 * *HCO3 * gAn[iHCO3] * gNAn[iHCO3] / (aH * gAn[iCO3] * gNAn[iCO3]);
    *HS = K1H2S * *H2Saq * gNeut[iH2Saq] * gNNeut[iH2Saq] / (aH * gAn[iHS] * gNAn[iHS]);
    if (TH2Saq > 0.0) mt = fMeSSpeciation(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, *ppt, ZP1, ZP2, ZP3, ZP4,
        ZP5, ZP6, ZP7, &root1, &root2, &root3);
    mn[iFeSaq] = KstFeSaq * mc[iFe] * *HS * gAn[iHS] * gNAn[iHS] * gCat[iFe] * gNCat[iFe] / (gNeut[iFeSaq] * gNNeut[iFeSaq] * aH);
    *S = K2HS * *HS * gAn[iHS] * gNAn[iHS] / (aH * gAn[iSion] * gNAn[iSion]);
    hydAc = aH * gAn[iAc] * gNAn[iAc] / (KHAc * gNeut[iHAcaq] * gNNeut[iHAcaq]) + 1.0;
    *AC = TAc / hydAc;
    *HAcaq = TAc - *AC;
    hydH2BO3 = aH * gAn[iH2BO3] * gNAn[iH2BO3] / (KH3BO3 * gNeut[iH3BO3] * gNNeut[iH3BO3]) + 1.0;
    *H2BO3 = TH3BO3 / hydH2BO3;
    hydNH3 = aH * gNeut[iNH3] * gNNeut[iNH3] / (KNH4 * gCat[iNH4] * gNCat[iNH4]) + 1.0;
    *NH3 = TNH4 / hydNH3;

    hydH2SiO4 = (aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq])) +
        (aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4])) + 1.0;
    *H2SiO4 = TH4SiO4 / hydH2SiO4;
    *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
    *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);

    if (igas == 10) {
        *H4SiO4 = KspAmSilica / gNeut[iH4SiO4aq];
        *H3SiO4 = KH4SiO4 * KspAmSilica / (aH * gAn[iH3SiO4]);
        *H2SiO4 = KH4SiO4 * KH3SiO3 * KspAmSilica / (aH * aH * gAn[iH2SiO4]);
        *pptAmSilica = TH4SiO4 - (*H2SiO4 + *H3SiO4 + *H4SiO4);
    }
    if (igas == 11) {
        *H4SiO4 = KspQuartz;
        *H3SiO4 = KH4SiO4 * KspQuartz / aH;
        *H2SiO4 = KH4SiO4 * KH3SiO3 * KspAmSilica / (aH * aH); // VB has KspAmSilica, perhaps typo
    }

    if (igas == 12) {
        *H2SiO4 = TH4SiO4_Greenalite / hydH2SiO4;
        *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
        *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);
    }
    if (igas == 13) {
        *H2SiO4 = TH4SiO4_Diopside / hydH2SiO4;
        *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
        *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);
    }
    if (igas == 14) {
        *H2SiO4 = TH4SiO4_Chrysotile / hydH2SiO4;
        *H3SiO4 = *H2SiO4 * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH3SiO3 * gAn[iH3SiO4] * gNAn[iH3SiO4]);
        *H4SiO4 = *H2SiO4 * aH * aH * gAn[iH2SiO4] * gNAn[iH2SiO4] / (KH4SiO4 * KH3SiO3 * gNeut[iH4SiO4aq] * gNNeut[iH4SiO4aq]);
    }

    faH = Alk - 2.0 * *ppt - (*HCO3 + 2.0 * *CO3 + *HS + 2.0 * *S + *AC + *NH3 + *H2BO3 + *H3SiO4 + 2.0 * *H2SiO4 + OH - H);

    if (igas == 10 || igas == 11) {
        *ppt = TH4SiO4 - (*H2SiO4 + *H3SiO4 + *H4SiO4);
        if (*ppt < 0.0) *ppt = 0.0;
    }
}

```

# C4_SSPEquilCalcs调用函数

## fMeSSpeciation

>code

```cpp
/**
 * @brief 金属硫化物水溶液物种化计算
 *        （只考虑水相，不包括与气相、油相的平衡；Cl- 物种化未考虑）
 *
 * @param im   金属索引 (如 iFe, iZn, iPb)
 * @param igas 气体标志 (3 表示硫化物沉淀)
 * @return double (未定义时返回 NAN)
 */
double fMeSSpeciation(int im, int igas, double* HS, double TFe, double TZn, double TPb, 
    double TH2Saq, double hydHS, double ppt, double ZP1, double ZP2, double ZP3, double ZP4, 
    double ZP5, double ZP6, double ZP7, double* mc, double* root1, double* root2, double* root3)
{
    double root1=0, root2=0, root3=0;
    double HSOld = *HS;
    double FeOld = TFe;
    double ZnOld = TZn;
    double PbOld = TPb;

    /* ------- 根据是否有沉淀 (ppt) 来计算初始溶解相浓度 mc[] ------- */
       /* Fe */
    if (im == iFe && igas == 3) { /* FeS 正在沉淀 */
        FeOld = TFe - ppt;
        mc[iFe] = (TFe - ppt) / (1.0 + ZP1 * *HS);
    }
    else {
        mc[iFe] = TFe / (1.0 + ZP1 * *HS);
    }

    /* Zn */
    if (im == iZn && igas == 3) { /* ZnS 正在沉淀 */
        ZnOld = TZn - ppt;
        mc[iZn] = (TZn - ppt) / (1.0 + ZP2 + ZP3 * pow(*HS, 2.0) + ZP4 * pow(*HS, 3.0));
    }
    else {
        mc[iZn] = TZn / (1.0 + ZP2 + ZP3 * pow(*HS, 2.0) + ZP4 * pow(*HS, 3.0));
    }

    /* Pb */
    if (im == iPb && igas == 3) { /* PbS 正在沉淀 */
        PbOld = TPb - ppt;
        mc[iPb] = (TPb - ppt) / (1.0 + ZP5 + ZP6 * pow(*HS, 2.0) + ZP7 * pow(*HS, 3.0));
    }
    else {
        mc[iPb] = TPb / (1.0 + ZP5 + ZP6 * pow(*HS, 2.0) + ZP7 * pow(*HS, 3.0));
    }

    /* ------- 有 Zn 或 Pb 时，求解多项式（可能为三次或二次）以求 HS ------- */
    if (mc[iZn] > 0.0 || mc[iPb] > 0.0) {
        double coef1 = 1.0;
        double denom = (mc[iZn] * ZP4 + mc[iPb] * ZP7);
        /* 若 denom = 0 可能造成除零，按 VB 的原逻辑直接除；如需防护可添加 epsilon 检查 */
        double coef2 = (mc[iZn] * ZP3 + mc[iPb] * ZP6) / denom;
        double coef3 = (hydHS + mc[iFe] * ZP1) / denom;
        double coef4;
        if (igas == 3) {
            coef4 = -(TH2Saq - ppt) / denom;
        }
        else {
            coef4 = -TH2Saq / denom;
        }

        double a = coef1 * pow(*HS, 3.0) / coef4;
        double b = coef2 * pow(*HS, 2.0) / coef4;

        if (fabs(a) < 1e-4) {
            if (fabs(b) < 1e-4) {
                *HS = -coef4 / coef3;
            }
            else {
                QuadraticRoots(coef2, coef3, coef4, root1, root2);
                *HS = (*root2 > *root1) ? *root2 : *root1;
            }
            if (*HS <= 0.0) return NAN; /* VB: GoTo 1000 */
        }
        else {
            CubicRoots(coef1, coef2, coef3, coef4, root1, root2, root3);
            *HS = *root1;
            if (*root2 > *HS) *HS = *root2;
            if (*root3 > *HS) *HS = *root3;
            if (*HS <= 0.0) {
                *HS = 0.0;
                return NAN; /* VB: GoTo 1000 */
            }
        }
    }
    /* ------- 若只有 Fe 存在，则直接解析 HS ------- */
    else if (mc[iFe] > 0.0) {
        if (igas == 3) {
            *HS = (TH2Saq - ppt) / (hydHS + ZP1 * mc[iFe]);
        }
        else {
            *HS = TH2Saq / (hydHS + ZP1 * mc[iFe]);
        }
    }
    /* 若都不存在可解的金属，则返回（VB: GoTo 1000） */
    else {
        return NAN;
    }

    /* ========== 下面展开所有 VB 中的不同组合情形的迭代收敛循环 ========== */

    /* Case A: TFe > 0 And HS > 0 And TZn > 0 And TPb > 0 */
    if (TFe > 0.0 && *HS > 0.0 && TZn > 0.0 && TPb > 0.0) {
        while (fabs((FeOld / (1.0 + ZP1 * *HS) - mc[iFe]) / mc[iFe]) > 0.001
            || fabs((PbOld / (1.0 + ZP5 + ZP6 * pow(*HS, 2.0) + ZP7 * pow(*HS, 3.0)) - mc[iPb]) / mc[iPb]) > 0.001
            || fabs((ZnOld / (1.0 + ZP2 + ZP3 * pow(*HS, 2.0) + ZP4 * pow(*HS, 3.0)) - mc[iZn]) / mc[iZn]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            MeSWhileloop(im, igas, HS, TFe, TZn, TPb,TH2Saq, hydHS, ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, mc,  root1,  root2,  root3);
        }
    }

    /* Case B: TFe > 0 And HS > 0 And TZn = 0 And TPb > 0 */
    if (TFe > 0.0 && *HS > 0.0 && TZn == 0.0 && TPb > 0.0) {
        while (fabs((FeOld / (1.0 + ZP1 * *HS) - mc[iFe]) / mc[iFe]) > 0.001
            || fabs((PbOld / (1.0 + ZP5 + ZP6 * pow(*HS, 2.0) + ZP7 * pow(*HS, 3.0)) - mc[iPb]) / mc[iPb]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            MeSWhileloop(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, mc, root1, root2, root3);
        }
    }

    /* Case C: TFe > 0 And HS > 0 And TZn > 0 And TPb = 0 */
    if (TFe > 0.0 && *HS > 0.0 && TZn > 0.0 && TPb == 0.0) {
        while (fabs((FeOld / (1.0 + ZP1 * *HS) - mc[iFe]) / mc[iFe]) > 0.001
            || fabs((ZnOld / (1.0 + ZP2 + ZP3 * pow(*HS, 2.0) + ZP4 * pow(*HS, 3.0)) - mc[iZn]) / mc[iZn]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            MeSWhileloop(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, mc, root1, root2, root3);
        }
    }

    /* Case D: TFe = 0 And HS > 0 And TZn > 0 And TPb > 0 */
    if (TFe == 0.0 && *HS > 0.0 && TZn > 0.0 && TPb > 0.0) {
        while (fabs((PbOld - mc[iPb]) / mc[iPb]) > 0.001
            || fabs((ZnOld / (1.0 + ZP2 + ZP3 * pow(*HS, 2.0) + ZP4 * pow(*HS, 3.0)) - mc[iZn]) / mc[iZn]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            MeSWhileloop(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, mc, root1, root2, root3);
        }
    }

    /* Case E: TFe = 0 And HS > 0 And TZn > 0 And TPb = 0 */
    if (TFe == 0.0 && *HS > 0.0 && TZn > 0.0 && TPb == 0.0) {
        while (fabs((ZnOld / (1.0 + ZP2 + ZP3 * pow(*HS, 2.0) + ZP4 * pow(*HS, 3.0)) - mc[iZn]) / mc[iZn]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            MeSWhileloop(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, mc, root1, root2, root3);
        }
    }

    /* Case F: TFe = 0 And HS > 0 And TZn = 0 And TPb > 0 */
    if (TFe == 0.0 && *HS > 0.0 && TZn == 0.0 && TPb > 0.0) {
        while (fabs((PbOld / (1.0 + ZP5 + ZP6 * pow(*HS, 2.0) + ZP7 * pow(*HS, 3.0)) - mc[iPb]) / mc[iPb]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            MeSWhileloop(im, igas, HS, TFe, TZn, TPb, TH2Saq, hydHS, ppt, ZP1, ZP2, ZP3, ZP4,
                ZP5, ZP6, ZP7, mc, root1, root2, root3);
        }
    }

    /* Case G: TFe > 0 And HS > 0 And TZn = 0 And TPb = 0
       这是只有 Fe 存在的情况，需要交替更新 mc(iFe) 与 HS 直到收敛 */
    if (TFe > 0.0 && *HS > 0.0 && TZn == 0.0 && TPb == 0.0) {
        while (fabs((FeOld - mc[iFe]) / mc[iFe]) > 0.001
            || fabs((HSOld - *HS) / *HS) > 0.001) {
            /* VB: FeOld = mc(iFe): HSOld = HS: */
            FeOld = mc[iFe];
            HSOld = *HS;

            if (igas == 3) {
                mc[iFe] = (TFe - ppt) / (1.0 + ZP1 * *HS);
                *HS = (TH2Saq - ppt) / (hydHS + ZP1 * mc[iFe]);
            }
            else {
                mc[iFe] = TFe / (1.0 + ZP1 * *HS);
                *HS = TH2Saq / (hydHS + ZP1 * mc[iFe]);
            }
        }
    }

    /* VB 末尾: 1000 fMeSSpeciation = Null */
    return NAN;
}

```

## MeSWhileloop

>code

```cpp
/**
 * @brief fMeSSpeciation 的迭代子过程
 * @param im   金属索引
 * @param igas 气体标志
 */
void MeSWhileloop(int im, int igas, double* HS, double TFe, double TZn, double TPb,
    double TH2Saq, double hydHS, double ppt, double ZP1, double ZP2, double ZP3, double ZP4,
    double ZP5, double ZP6, double ZP7, double* mc, double* root1, double* root2, double* root3)
{
    double HSOld = *HS;
    double coef1 = 1.0;
    double coef2 = (mc[iZn] * ZP3 + mc[iPb] * ZP6) / (mc[iZn] * ZP4 + mc[iPb] * ZP7);
    double coef3 = (hydHS + mc[iFe] * ZP1) / (mc[iZn] * ZP4 + mc[iPb] * ZP7);
    double coef4 = -TH2Saq / (mc[iZn] * ZP4 + mc[iPb] * ZP7);

    double a = coef1 * pow(*HS, 3) / coef4;
    double b = coef2 * pow(*HS, 2) / coef4;

    if (fabs(a) < 1e-4) {
        if (fabs(b) < 1e-4) {
            *HS = -coef4 / coef3;
        }
        else {
            QuadraticRoots(coef2, coef3, coef4, root1, root2);
            *HS = (*root2 > *root1) ? *root2 : *root1;
        }
        if (*HS <= 0) return;
    }
    else {
        CubicRoots(coef1, coef2, coef3, coef4, root1, root2, root3);
        *HS = *root1;
        if (*root2 > *HS) *HS = *root2;
        if (*root3 > *HS) *HS = *root3;
        if (*HS <= 0) {
            *HS = 0;
            return;
        }
    }

    // 更新 mc
    if (im == iFe && igas == 3)
        mc[iFe] = (TFe - ppt) / (1.0 + ZP1 * *HS);
    else
        mc[iFe] = TFe / (1.0 + ZP1 * *HS);

    if (im == iZn && igas == 3)
        mc[iZn] = (TZn - ppt) / (1.0 + ZP2 + ZP3 * pow(*HS, 2) + ZP4 * pow(*HS, 3));
    else
        mc[iZn] = TZn / (1.0 + ZP2 + ZP3 * pow(*HS, 2) + ZP4 * pow(*HS, 3));

    if (im == iPb && igas == 3)
        mc[iPb] = (TPb - ppt) / (1.0 + ZP5 + ZP6 * pow(*HS, 2) + ZP7 * pow(*HS, 3));
    else
        mc[iPb] = TPb / (1.0 + ZP5 + ZP6 * pow(*HS, 2) + ZP7 * pow(*HS, 3));
}
```